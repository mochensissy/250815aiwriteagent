# 20250822 豆包API CORS跨域问题解决方案

## 问题描述

在浏览器中直接调用火山引擎豆包API时遇到CORS（跨域资源共享）错误：

```
Access to fetch at 'https://ark.cn-beijing.volces.com/api/v3/images/generations' 
from origin 'http://localhost:5173' has been blocked by CORS policy
```

## 问题根源分析

1. **CORS跨域限制**：火山引擎豆包API不允许直接从浏览器调用
2. **安全策略**：浏览器的同源策略阻止了跨域请求
3. **网络错误**：`net::ERR_FAILED` 表明连接被完全阻止

## 解决方案

### 1. 添加Vite代理配置

在 `vite.config.ts` 中添加代理配置：

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

export default defineConfig({
  plugins: [react()],
  optimizeDeps: {
    exclude: ['lucide-react'],
  },
  server: {
    proxy: {
      // 代理豆包API请求以解决CORS问题
      '/api/doubao': {
        target: 'https://ark.cn-beijing.volces.com',
        changeOrigin: true,
        rewrite: (path) => path.replace(/^\/api\/doubao/, '/api/v3/images/generations'),
        headers: {
          'Origin': 'https://ark.cn-beijing.volces.com'
        }
      }
    }
  }
});
```

### 2. 更新API端点配置

修改 `src/utils/storage.ts` 中的默认配置：

```typescript
// 原配置
endpoint: 'https://ark.cn-beijing.volces.com/api/v3/images/generations'

// 新配置（使用代理）
endpoint: '/api/doubao'
```

### 3. 更新API管理界面

修改 `src/components/Settings/APIManager.tsx`：

```typescript
// 更新占位符文本
placeholder="/api/doubao (通过代理解决CORS问题)"

// 更新默认配置
doubao: {
  apiKey: 'ca9d6a48-f76d-4c29-a621-2cf259a55b2f',
  endpoint: '/api/doubao',
  model: 'doubao-seedream-3-0-t2i-250415'
}
```

## 技术实现细节

### 代理工作原理

1. **客户端请求**：浏览器向 `http://localhost:5173/api/doubao` 发送请求
2. **Vite代理转发**：开发服务器将请求转发到 `https://ark.cn-beijing.volces.com/api/v3/images/generations`
3. **服务器响应**：火山引擎API返回结果给Vite服务器
4. **返回客户端**：Vite服务器将结果返回给浏览器

### API调用参数

```javascript
{
  model: 'doubao-seedream-3-0-t2i-250415',
  prompt: '图片描述文本',
  n: 1,
  size: '1024x1024',
  response_format: 'url'
}
```

## 测试验证

### 命令行测试

```bash
curl -X POST http://localhost:5173/api/doubao \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer ca9d6a48-f76d-4c29-a621-2cf259a55b2f" \
  -d '{
    "model": "doubao-seedream-3-0-t2i-250415",
    "prompt": "测试图片生成",
    "n": 1,
    "size": "512x512",
    "response_format": "url"
  }'
```

### 测试结果

✅ **连接测试**：状态码 200 OK  
✅ **图片生成**：成功生成多张测试图片  
✅ **响应时间**：正常（3-5秒）  
✅ **Token使用**：正常计费  

### 成功案例

1. **红色玫瑰花**：简约风格，白色背景 ✅
2. **科技logo**：现代简约设计 ✅  
3. **办公室场景**：明亮整洁的现代办公室 ✅

## 注意事项

1. **开发环境限制**：此解决方案仅适用于开发环境
2. **生产环境**：需要后端服务器代理或使用服务端API调用
3. **API密钥安全**：避免在前端代码中暴露API密钥
4. **重启服务器**：修改Vite配置后需要重启开发服务器

## 相关文件修改

- `vite.config.ts` - 添加代理配置
- `src/utils/storage.ts` - 更新默认端点
- `src/components/Settings/APIManager.tsx` - 更新界面配置
- `src/utils/api.ts` - API调用逻辑（无需修改）

## 最终效果

豆包API现在可以在应用中正常使用：
- 🖼️ 文章配图生成
- 📸 封面图片制作  
- 🎨 自定义图片生成
- 🧪 API连接测试

## 解决时间

**开始时间**：2025-08-22 09:00  
**解决时间**：2025-08-22 09:30  
**总耗时**：约30分钟

## 技术栈

- **开发工具**：Vite 5.4.2
- **前端框架**：React 18.3.1 + TypeScript
- **API服务**：火山引擎豆包生图API
- **解决方案**：开发服务器代理
