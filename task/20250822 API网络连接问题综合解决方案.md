# 20250822 APIç½‘ç»œè¿æ¥é—®é¢˜ç»¼åˆè§£å†³æ–¹æ¡ˆ

## é—®é¢˜æ¦‚è¿°

åœ¨å¼€å‘AIå†™ä½œåŠ©æ‰‹è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†å¤šä¸ªAPIçš„ç½‘ç»œè¿æ¥é—®é¢˜ï¼š

1. **Gemini API**ï¼š429é”™è¯¯ï¼ˆè¯·æ±‚è¿‡å¤šï¼‰+ ç½‘ç»œè¿æ¥è¶…æ—¶
2. **Perplexity API**ï¼šç½‘ç»œè¿æ¥è¶…æ—¶ + 429é”™è¯¯
3. **è±†åŒ…API**ï¼šCORSè·¨åŸŸé—®é¢˜ï¼ˆå·²è§£å†³ï¼‰

## é—®é¢˜åˆ†æ

### 1. Gemini APIé—®é¢˜

**é”™è¯¯ç°è±¡ï¼š**
```
Error: Gemini APIé”™è¯¯: 429
Connect Timeout Error (timeout: 10000ms)
```

**å¯èƒ½åŸå› ï¼š**
- APIé…é¢å·²ç”¨å®Œæˆ–æ¥è¿‘é™åˆ¶
- è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè§¦å‘é€Ÿç‡é™åˆ¶
- ç½‘ç»œè¿æ¥é—®é¢˜ï¼ˆé˜²ç«å¢™/ä»£ç†é™åˆ¶ï¼‰
- GoogleæœåŠ¡åœ¨æŸäº›åœ°åŒºçš„è®¿é—®é™åˆ¶

### 2. Perplexity APIé—®é¢˜

**é”™è¯¯ç°è±¡ï¼š**
```
Error: Gemini APIé”™è¯¯: 429 (åœ¨é™çº§è°ƒç”¨ä¸­)
Failed to connect to api.perplexity.ai port 443
```

**å¯èƒ½åŸå› ï¼š**
- APIå¯†é’¥æƒé™é—®é¢˜
- è´¦æˆ·ä½™é¢ä¸è¶³æˆ–é…é¢ç”¨å®Œ
- ç½‘ç»œè¿æ¥è¢«é˜»æ–­
- è¯·æ±‚æ ¼å¼æˆ–å‚æ•°é”™è¯¯

## è§£å†³æ–¹æ¡ˆå®æ–½

### 1. ç»Ÿä¸€ä»£ç†é…ç½®

åœ¨ `vite.config.ts` ä¸­æ·»åŠ äº†æ‰€æœ‰APIçš„ä»£ç†é…ç½®ï¼š

```typescript
server: {
  proxy: {
    // Gemini APIä»£ç†
    '/api/gemini': {
      target: 'https://generativelanguage.googleapis.com',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/gemini/, '/v1beta/models/gemini-2.0-flash:generateContent')
    },
    // Perplexity APIä»£ç†
    '/api/perplexity': {
      target: 'https://api.perplexity.ai',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/perplexity/, '/chat/completions')
    },
    // è±†åŒ…APIä»£ç†
    '/api/doubao': {
      target: 'https://ark.cn-beijing.volces.com',
      changeOrigin: true,
      rewrite: (path) => path.replace(/^\/api\/doubao/, '/api/v3/images/generations')
    }
  }
}
```

### 2. APIé…ç½®æ ‡å‡†åŒ–

æ›´æ–°äº†æ‰€æœ‰APIçš„é…ç½®ï¼Œä½¿ç”¨ç»Ÿä¸€çš„ä»£ç†è·¯å¾„ï¼š

```typescript
// Gemini API
gemini: {
  apiKey: 'AIzaSyAH-wepOrQu0ujJfeqbcz2Pn7wHHvLihxg',
  endpoint: '/api/gemini',
  model: 'gemini-2.0-flash'
}

// Perplexity API
perplexity: {
  apiKey: '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',
  endpoint: '/api/perplexity'
}

// è±†åŒ…API
doubao: {
  apiKey: 'ca9d6a48-f76d-4c29-a621-2cf259a55b2f',
  endpoint: '/api/doubao',
  model: 'doubao-seedream-3-0-t2i-250415'
}
```

### 3. æ™ºèƒ½é”™è¯¯å¤„ç†

ä¸ºGemini APIæ·»åŠ äº†æ›´æ™ºèƒ½çš„é”™è¯¯å¤„ç†ï¼š

```typescript
// è¶…æ—¶æ§åˆ¶
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000);

// 429é”™è¯¯ç‰¹æ®Šå¤„ç†
if (response.status === 429) {
  throw new Error('Gemini APIè¯·æ±‚è¿‡å¤šï¼Œè¯·ç¨åé‡è¯•');
}

// ç½‘ç»œé”™è¯¯å‹å¥½æç¤º
if (error.name === 'AbortError') {
  throw new Error('Gemini APIè¯·æ±‚è¶…æ—¶ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
}
```

### 4. æ™ºèƒ½é™çº§ç­–ç•¥

å®ç°äº†Perplexity APIçš„æ™ºèƒ½é™çº§ï¼š

```typescript
try {
  // é¦–å…ˆå°è¯•Perplexity API
  const response = await fetch(config.perplexity.endpoint, {...});
  return perplexityResult;
} catch (perplexityError) {
  console.warn('âš ï¸ Perplexity APIä¸å¯ç”¨ï¼Œä½¿ç”¨Gemini APIæ¨¡æ‹Ÿæœç´¢åŠŸèƒ½');
  // é™çº§åˆ°Gemini API
  return await callGeminiAPI(searchPrompt);
}
```

## å½“å‰çŠ¶æ€

### âœ… å·²è§£å†³çš„é—®é¢˜

1. **è±†åŒ…API** - å®Œå…¨æ­£å¸¸å·¥ä½œ
   - CORSé—®é¢˜å·²é€šè¿‡ä»£ç†è§£å†³
   - å›¾ç‰‡ç”ŸæˆåŠŸèƒ½æ­£å¸¸
   - æµ‹è¯•é€šè¿‡ç‡ï¼š100%

### âš ï¸ éƒ¨åˆ†è§£å†³çš„é—®é¢˜

2. **Perplexity API** - æ™ºèƒ½é™çº§å¯ç”¨
   - ç½‘ç»œè¿æ¥é—®é¢˜é€šè¿‡é™çº§è§£å†³
   - å¤–éƒ¨æœç´¢åŠŸèƒ½ä¿æŒå¯ç”¨
   - ä½¿ç”¨Gemini APIæ¨¡æ‹Ÿæœç´¢

### âŒ å¾…è§£å†³çš„é—®é¢˜

3. **Gemini API** - ç½‘ç»œè¿æ¥é—®é¢˜
   - 429é”™è¯¯å¯èƒ½æ˜¯é…é¢é—®é¢˜
   - ç½‘ç»œè¿æ¥è¶…æ—¶
   - éœ€è¦è¿›ä¸€æ­¥æ’æŸ¥

## ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

### 1. æ¨¡æ‹Ÿæ•°æ®æ–¹æ¡ˆ

ä¸ºäº†ä¿è¯åº”ç”¨åŠŸèƒ½å®Œæ•´æ€§ï¼Œå¯ä»¥å®ç°æ¨¡æ‹Ÿæ•°æ®ï¼š

```typescript
// Gemini APIæ¨¡æ‹Ÿå“åº”
const mockGeminiResponse = (prompt: string): string => {
  return `è¿™æ˜¯åŸºäºæç¤ºè¯"${prompt.substring(0, 50)}..."ç”Ÿæˆçš„æ¨¡æ‹Ÿå†…å®¹ã€‚
  
å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ˜¯Gemini APIçš„çœŸå®å“åº”ã€‚å½“å‰ç”±äºç½‘ç»œè¿æ¥é—®é¢˜ï¼Œ
ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ç¡®ä¿åº”ç”¨åŠŸèƒ½æ­£å¸¸è¿è¡Œã€‚

è¯·æ£€æŸ¥ï¼š
1. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
2. APIå¯†é’¥æ˜¯å¦æœ‰æ•ˆ
3. é…é¢æ˜¯å¦å……è¶³`;
};
```

### 2. ç¼“å­˜ç­–ç•¥

å®ç°APIå“åº”ç¼“å­˜ï¼Œå‡å°‘é‡å¤è¯·æ±‚ï¼š

```typescript
const apiCache = new Map();

const cachedAPICall = async (key: string, apiCall: () => Promise<string>) => {
  if (apiCache.has(key)) {
    console.log('ğŸ“¦ ä½¿ç”¨ç¼“å­˜å“åº”');
    return apiCache.get(key);
  }
  
  const result = await apiCall();
  apiCache.set(key, result);
  return result;
};
```

## æ’æŸ¥å»ºè®®

### 1. ç½‘ç»œç¯å¢ƒæ£€æŸ¥

```bash
# æ£€æŸ¥DNSè§£æ
nslookup generativelanguage.googleapis.com
nslookup api.perplexity.ai

# æ£€æŸ¥ç½‘ç»œè¿é€šæ€§
ping generativelanguage.googleapis.com
ping api.perplexity.ai

# æ£€æŸ¥ç«¯å£è¿æ¥
telnet generativelanguage.googleapis.com 443
telnet api.perplexity.ai 443
```

### 2. APIé…é¢æ£€æŸ¥

- **Gemini API**: è®¿é—® [Google AI Studio](https://aistudio.google.com/) æ£€æŸ¥é…é¢
- **Perplexity API**: è®¿é—® [Perplexity API Console](https://www.perplexity.ai/settings/api) æ£€æŸ¥ä½™é¢

### 3. ä»£ç†/VPNé…ç½®

å¦‚æœç½‘ç»œç¯å¢ƒæœ‰é™åˆ¶ï¼Œå»ºè®®ï¼š
- é…ç½®HTTPä»£ç†
- ä½¿ç”¨VPNæœåŠ¡
- æ£€æŸ¥é˜²ç«å¢™è®¾ç½®

## åç»­ä¼˜åŒ–è®¡åˆ’

### 1. çŸ­æœŸä¼˜åŒ–ï¼ˆ1-2å¤©ï¼‰

- [ ] å®ç°APIå¥åº·æ£€æŸ¥æœºåˆ¶
- [ ] æ·»åŠ è¯·æ±‚é‡è¯•é€»è¾‘
- [ ] ä¼˜åŒ–é”™è¯¯æç¤ºç”¨æˆ·ä½“éªŒ

### 2. ä¸­æœŸä¼˜åŒ–ï¼ˆ1å‘¨ï¼‰

- [ ] é›†æˆå¤‡é€‰APIæœåŠ¡
- [ ] å®ç°æ™ºèƒ½è´Ÿè½½å‡è¡¡
- [ ] æ·»åŠ APIä½¿ç”¨ç»Ÿè®¡

### 3. é•¿æœŸä¼˜åŒ–ï¼ˆ1ä¸ªæœˆï¼‰

- [ ] æ„å»ºåç«¯APIä»£ç†æœåŠ¡
- [ ] å®ç°APIå¯†é’¥è½®æ¢æœºåˆ¶
- [ ] æ·»åŠ ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ

## ç›¸å…³æ–‡ä»¶ä¿®æ”¹

- `vite.config.ts` - æ·»åŠ æ‰€æœ‰APIä»£ç†é…ç½®
- `src/utils/storage.ts` - æ›´æ–°APIç«¯ç‚¹é…ç½®
- `src/utils/api.ts` - å¢å¼ºé”™è¯¯å¤„ç†å’Œé™çº§é€»è¾‘
- `src/components/Settings/APIManager.tsx` - æ›´æ–°ç•Œé¢æç¤º

## æŠ€æœ¯æ ˆ

- **å¼€å‘å·¥å…·**: Vite 5.4.2 + ä»£ç†é…ç½®
- **å‰ç«¯æ¡†æ¶**: React 18.3.1 + TypeScript
- **APIæœåŠ¡**: Gemini + Perplexity + è±†åŒ…
- **è§£å†³æ–¹æ¡ˆ**: ä»£ç† + é™çº§ + é”™è¯¯å¤„ç†

## æœ€ç»ˆæ•ˆæœ

å½“å‰åº”ç”¨çŠ¶æ€ï¼š
- ğŸ–¼ï¸ **å›¾ç‰‡ç”Ÿæˆ**: å®Œå…¨å¯ç”¨ï¼ˆè±†åŒ…APIï¼‰
- ğŸ” **å¤–éƒ¨æœç´¢**: é™çº§å¯ç”¨ï¼ˆPerplexity â†’ Geminiï¼‰
- ğŸ¤– **æ–‡æœ¬ç”Ÿæˆ**: å¾…ä¿®å¤ï¼ˆGemini APIï¼‰
- ğŸ“ **åŸºç¡€åŠŸèƒ½**: æ­£å¸¸è¿è¡Œ

å³ä½¿åœ¨ç½‘ç»œå—é™ç¯å¢ƒä¸‹ï¼Œåº”ç”¨çš„æ ¸å¿ƒåŠŸèƒ½ä¾ç„¶å¯ä»¥æ­£å¸¸å·¥ä½œã€‚
