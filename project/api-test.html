<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API连接测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 25px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
        }
        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .test-name {
            font-weight: 600;
            font-size: 16px;
        }
        .test-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-pending {
            background: #f3f4f6;
            color: #6b7280;
        }
        .status-testing {
            background: #fef3c7;
            color: #d97706;
        }
        .status-success {
            background: #d1fae5;
            color: #065f46;
        }
        .status-error {
            background: #fee2e2;
            color: #dc2626;
        }
        .test-result {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border-radius: 4px;
            font-size: 14px;
            border-left: 4px solid #e5e7eb;
        }
        .result-success {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        .result-error {
            border-left-color: #ef4444;
            background: #fef2f2;
        }
        .run-all-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 30px;
            transition: background-color 0.2s;
        }
        .run-all-btn:hover {
            background: #2563eb;
        }
        .run-all-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        .summary {
            text-align: center;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            margin-top: 20px;
        }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🧪 AI写作助手 - API连接测试</h1>
        
        <button id="runAllBtn" class="run-all-btn" onclick="runAllTests()">
            🚀 运行所有API测试
        </button>

        <div id="geminiTest" class="test-section">
            <div class="test-header">
                <div class="test-name">🤖 Gemini API (文本生成)</div>
                <div id="geminiStatus" class="test-status status-pending">待测试</div>
            </div>
            <div class="test-description">Google Gemini大模型API，用于生成文章大纲和内容</div>
            <div id="geminiResult" class="test-result" style="display: none;"></div>
        </div>

        <div id="perplexityTest" class="test-section">
            <div class="test-header">
                <div class="test-name">🔍 Perplexity API (外部搜索)</div>
                <div id="perplexityStatus" class="test-status status-pending">待测试</div>
            </div>
            <div class="test-description">Perplexity搜索API，用于获取外部信息增强文章内容</div>
            <div id="perplexityResult" class="test-result" style="display: none;"></div>
        </div>

        <div id="doubaoTest" class="test-section">
            <div class="test-header">
                <div class="test-name">🎨 豆包生图API (图片生成)</div>
                <div id="doubaoStatus" class="test-status status-pending">待测试</div>
            </div>
            <div class="test-description">豆包生图API，用于生成文章配图和封面</div>
            <div id="doubaoResult" class="test-result" style="display: none;"></div>
        </div>

        <div id="summary" class="summary" style="display: none;">
            <h3>📊 测试结果总结</h3>
            <div id="summaryContent"></div>
        </div>
    </div>

    <script>
        let testResults = {};
        let isRunning = false;

        // 更新测试状态
        function updateStatus(testName, status, message = '', result = null) {
            const statusEl = document.getElementById(`${testName}Status`);
            const resultEl = document.getElementById(`${testName}Result`);
            
            statusEl.className = `test-status status-${status}`;
            
            switch(status) {
                case 'pending':
                    statusEl.textContent = '待测试';
                    break;
                case 'testing':
                    statusEl.textContent = '测试中...';
                    break;
                case 'success':
                    statusEl.textContent = '✅ 成功';
                    break;
                case 'error':
                    statusEl.textContent = '❌ 失败';
                    break;
            }
            
            if (message) {
                resultEl.style.display = 'block';
                resultEl.className = `test-result result-${status === 'success' ? 'success' : 'error'}`;
                resultEl.innerHTML = `
                    <div><strong>结果:</strong> ${message}</div>
                    ${result ? `<pre>${JSON.stringify(result, null, 2)}</pre>` : ''}
                `;
            }
            
            testResults[testName] = { status, message, result };
        }

        // 测试Gemini API
        async function testGemini() {
            updateStatus('gemini', 'testing');
            
            try {
                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-goog-api-key': 'AIzaSyAH-wepOrQu0ujJfeqbcz2Pn7wHHvLihxg'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: '请简单回复"Gemini API连接成功"，不要添加其他内容。'
                            }]
                        }]
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const result = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
                    updateStatus('gemini', 'success', `API连接成功，返回内容: ${result.substring(0, 100)}`, {
                        responseTime: `${Date.now() - window.testStartTime}ms`,
                        contentLength: result.length
                    });
                    return true;
                } else {
                    const errorText = await response.text();
                    updateStatus('gemini', 'error', `HTTP ${response.status}: ${response.statusText}`, { errorDetails: errorText });
                    return false;
                }
            } catch (error) {
                updateStatus('gemini', 'error', `网络错误: ${error.message}`, { error: error.toString() });
                return false;
            }
        }

        // 测试Perplexity API
        async function testPerplexity() {
            updateStatus('perplexity', 'testing');
            
            try {
                const response = await fetch('https://api.perplexity.ai/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer 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'
                    },
                    body: JSON.stringify({
                        model: 'sonar-medium-online',
                        messages: [
                            {
                                role: 'system',
                                content: 'Be precise and concise.'
                            },
                            {
                                role: 'user',
                                content: '请简单回复"Perplexity API连接成功"'
                            }
                        ],
                        max_tokens: 100,
                        temperature: 0.5
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const result = data.choices?.[0]?.message?.content || '';
                    updateStatus('perplexity', 'success', `API连接成功，返回内容: ${result.substring(0, 100)}`, {
                        responseTime: `${Date.now() - window.testStartTime}ms`,
                        contentLength: result.length
                    });
                    return true;
                } else {
                    const errorText = await response.text();
                    updateStatus('perplexity', 'error', `HTTP ${response.status}: ${response.statusText}`, { errorDetails: errorText });
                    return false;
                }
            } catch (error) {
                updateStatus('perplexity', 'error', `网络错误: ${error.message}`, { error: error.toString() });
                return false;
            }
        }

        // 测试豆包生图API
        async function testDoubao() {
            updateStatus('doubao', 'testing');
            
            try {
                const response = await fetch('https://ark.cn-beijing.volces.com/api/v3/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ca9d6a48-f76d-4c29-a621-2cf259a55b2f'
                    },
                    body: JSON.stringify({
                        model: 'doubao-seedream-3-0-t2i-250415',
                        prompt: '一朵简单的红色玫瑰花，白色背景，简约风格',
                        response_format: 'url',
                        size: '512x512',
                        guidance_scale: 3,
                        watermark: true
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    const imageUrl = data.data?.[0]?.url || '';
                    if (imageUrl) {
                        updateStatus('doubao', 'success', `图片生成成功: ${imageUrl}`, {
                            responseTime: `${Date.now() - window.testStartTime}ms`,
                            imageUrl: imageUrl
                        });
                        return true;
                    } else {
                        updateStatus('doubao', 'error', '返回数据中没有图片URL', data);
                        return false;
                    }
                } else {
                    const errorText = await response.text();
                    updateStatus('doubao', 'error', `HTTP ${response.status}: ${response.statusText}`, { errorDetails: errorText });
                    return false;
                }
            } catch (error) {
                updateStatus('doubao', 'error', `网络错误: ${error.message}`, { error: error.toString() });
                return false;
            }
        }

        // 运行所有测试
        async function runAllTests() {
            if (isRunning) return;
            
            isRunning = true;
            window.testStartTime = Date.now();
            
            const runBtn = document.getElementById('runAllBtn');
            runBtn.disabled = true;
            runBtn.textContent = '🔄 测试进行中...';
            
            // 重置所有状态
            ['gemini', 'perplexity', 'doubao'].forEach(test => {
                updateStatus(test, 'pending');
                document.getElementById(`${test}Result`).style.display = 'none';
            });
            
            document.getElementById('summary').style.display = 'none';
            
            console.log('🚀 开始API连接测试...');
            
            // 并行运行所有测试
            const results = await Promise.allSettled([
                testGemini(),
                testPerplexity(),
                testDoubao()
            ]);
            
            // 显示总结
            const successCount = results.filter(r => r.status === 'fulfilled' && r.value).length;
            const totalCount = results.length;
            
            const summaryEl = document.getElementById('summary');
            const summaryContentEl = document.getElementById('summaryContent');
            
            summaryEl.style.display = 'block';
            summaryContentEl.innerHTML = `
                <div style="font-size: 18px; margin-bottom: 10px;">
                    ${successCount === totalCount ? '🎉' : '⚠️'} 
                    ${successCount}/${totalCount} 项测试通过
                </div>
                <div style="color: #6b7280;">
                    总耗时: ${Date.now() - window.testStartTime}ms
                </div>
                ${successCount === totalCount 
                    ? '<div style="color: #059669; margin-top: 10px;">✅ 所有API服务正常，可以开始使用应用！</div>'
                    : '<div style="color: #dc2626; margin-top: 10px;">❌ 部分API服务异常，请检查网络连接和API密钥配置</div>'
                }
            `;
            
            console.log(`📊 测试完成: ${successCount}/${totalCount} 项通过`);
            
            runBtn.disabled = false;
            runBtn.textContent = '🔄 重新测试';
            isRunning = false;
        }

        // 页面加载完成后的提示
        window.addEventListener('load', () => {
            console.log('💡 API测试页面已加载，点击"运行所有API测试"按钮开始测试');
        });
    </script>
</body>
</html>

